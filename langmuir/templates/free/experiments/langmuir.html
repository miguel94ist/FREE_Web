{% extends 'free/experiment.html' %}
{% load static %}
{% load i18n %}


{% block experiment_head %}
    <!-- pendulum libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.8.0/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/1.4.0/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/1.2.1/chartjs-plugin-zoom.min.js"></script>

     <!-- slider  -->
     <script src="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.8.4/components/slider.min.js"></script>
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.8.4/components/slider.min.css">
 
    <!-- pendulum libraries -->


    <script src="https://unpkg.com/chartjs-chart-error-bars@3.7.2/build/index.umd.min.js"></script>
    <script src="https://d3js.org/d3-array.v3.min.js"></script>


{% endblock %}  


{% block configtab %}
<!-- Begin of the configuration tab-->
    
    
        <div class="ui two column grid container">
            <div class="column">
                <div class="ui segment">
                    <legend> <h3>{% trans 'Sweeping Voltage [Vpp]'%}</h3></legend>
                    <div style="padding-top: 5%;"  class="ui blue small bottom aligned labeled  slider"  id="slider-max_duty" ></div>
                        
                        <div class="ui input" >
                            <input class="free-input" type="number" id="max_duty">
                        </div>
                </div>
            </div>
            <div class="column">
                <div class="ui segment">
                    <legend><h3>{% trans 'Period for Sweeping Signal  [ms]'%}</h3></legend>
                    <div style="padding-top: 5%;"  class="ui blue small bottom aligned labeled  slider" id="slider-sigperiod" ></div>
                        
                        <div class="ui input">
                            <input class="free-input" type="number" id="sigperiod">
                        </div>
                </div>
            </div>
        </div>
		<!-- 2 -->
        <div class="ui two column grid container">
            <div class="column">
                <div class="ui segment">
                    <legend> <h3>{% trans 'Number of Samples per Period'%}</h3></legend>
                    <div style="padding-top: 5%;"  class="ui blue small bottom aligned labeled slider"  id="slider-numsamps" ></div>
                        
                        <div class="ui input" >
                            <input class="free-input" type="number" id="numsamps">
                        </div>
                </div>
            </div>
			
			 <div class="column">
                <div class="ui segment">
                    <legend> <h3>{% trans 'Number of Periods '%}</h3></legend>
                    <div style="padding-top: 5%;"  class="ui blue small bottom aligned labeled slider"  id="slider-numperiod" ></div>
                        
                        <div class="ui input" >
                            <input class="free-input" type="number" id="numperiod">
                        </div>
                </div>
            </div>
           
        </div>
		<!--3-->
		<div class="ui two column grid container">
            <div class="column">
                <div class="ui segment">
                    <legend> <h3>{% trans 'Gas Injection Time [ms]'%}</h3></legend>
                    <div style="padding-top: 5%;"  class="ui blue small bottom aligned labeled slider"  id="slider-pressure" ></div>
                        
                        <div class="ui input" >
                            <input class="free-input" type="number" id="pressure">
                        </div>
                </div>
            </div>
			
			 <div class="column">
                <div class="ui segment">
                    <legend> <h3>{% trans 'Gas Selection'%}</h3></legend>
					
                    <div class="field" id="radio">
                        <div class="ui  blue radio checkbox langmuir">
                             <input type="radio" name="frequency" checked="checked"  value="1">
                                 <label>Helium</label>
                        </div>
						
                        <div class="field">
                            <div class="ui radio checkbox langmuir">
                                <input type="radio" name="frequency"  value="2">
                                    <label>Nitrogen</label>
                            </div>
                        </div>		
						
					    <div class="field">
                            <div class="ui radio checkbox langmuir">
                                <input type="radio" name="frequency"  value="3">
                                    <label>Argon</label>
                            </div>
                        </div>
							 
				    </div>
                </div>
            </div>
           
        </div>
		<!--4-->
		<div class="ui two column grid container">
            <div class="column">
                <div class="ui segment">
                    <legend> <h3>{% trans 'Background Pressure [Pa]'%}</h3></legend>
                    <div style="padding-top: 5%;"  class="ui blue small bottom aligned labeled  slider"  id="slider-pump_press" ></div>
                        
                        <div class="ui input" >
                            <input class="free-input" type="number" id="pump_press">
                        </div>
                </div>
            </div>
           
        </div>
		
		
		
<!-- End of the configuration tab-->
{% endblock %}



<!-- Begin of the execution tab-->
{% block executiontab %}
<div class="ui grid stackable">
    <div class="row">
        <div class=" ten wide column">
            <h3>Distance vs Time</h3>
                <div >
                    <canvas id="plot_period_histogram"></canvas>
                </div>
        </div>
   
    </div>
	
    <div class="row">
        
        <div class="eight wide column">
            <h3>Velocidade Linear vs Amostra</h3>
                <div >
                    <canvas id="plot_sample_velocity"></canvas>
                </div>
        </div>
        <div class="eight wide column">
            <h3>Velocidade Linear vs Amostra</h3>
                <div >
                    <canvas id="plot_sample_period"></canvas>
                </div>
        </div>
    </div>
</div>

    <table id="results_table" class="ui celled table display" style="width:100%">
        <thead>
            <tr>
                <th id="time">{% trans "Time" %}</th>
                <th id="adc_value1">{% trans "Voltage [V]" %}</th>
                <th id="adc_value2">{% trans "Current[uA]" %}</th>
                <th id="adc_value3">{% trans "Pressure[mBar]" %}</th>
            </tr>
        </thead>
    </table>
{% endblock %}   
<!-- End of the execution tab-->

		
{% block protocol_auxiliary_functions %}

<script>
    var receive_error_velocity
    var receive_error_period

    var plot_sample_velocity
    var plot_sample_period
    var plot_period_histogram
 var period_data = []


function process_final_data(data_line){


}

function process_partial_data(data_line){
    sample_number = parseInt(data_line.value.Sample_number) 
    val3 = parseFloat(data_line.value.Val3)
    val1 = parseFloat(data_line.value.Val1)
   
    plot_sample_velocity.data.datasets[0].data.push({
        x: sample_number, 
        y: val3,
        yMin: val3 - receive_error_velocity,
        yMax: val3 + receive_error_velocity,
    });
    plot_sample_velocity.update();



    period_data.push(val1)

    bin1 = d3.bin()
    histo = bin1(period_data);
    const bins = histo.map((k, i) => (k.x0+ " .. "+k.x1 ));
    const data = histo.map((k, i) => (k.length));
    plot_period_histogram.data.labels = bins
    plot_period_histogram.data.datasets[0].data = data
    plot_period_histogram.update();


    plot_sample_period.data.datasets[0].data.push({
        x: sample_number, 
        y: val1,
        yMin: val1 - receive_error_period,
        yMax: val1 + receive_error_period,
    });
    plot_sample_period.update();

}

function on_save_experiment_UI(){

}





function on_ready_experiment_UI(){

    configure_slider("max_duty")
    configure_slider("sigperiod")
	configure_slider("numsamps")
	configure_slider("numperiod")
	configure_slider("pressure")
	configure_radio()
	configure_slider("pump_press")
	
	
    receive_error_velocity = 0.1;
    receive_error_period = 0.0005;//response.data.value.e_period;

    ctx = $("#plot_sample_velocity")[0].getContext('2d');
    plot_sample_velocity = new Chart(ctx, {
        type: 'scatterWithErrorBars',
        data: {
            datasets: [{
                borderColor: "blue",
                backgroundColor: "blue",
                data: [ ],
            },],
        },
        options: {
            plugins: {
                legend: {
                    display: false,
                }, 
                autocolors: false,
            },
            scales: {
                y: {
                    title:{
                        display: true, 
                        text: gettext('Linear velocity [cm/s]'),
                    },
                    min: 8.5,
                    max: 9.5,
                },
                x: {
                    title:{
                        display: true, 
                        text: gettext('# Samples'),
                    },
                },
            },
        }
    });

    ctx = $("#plot_period_histogram")[0].getContext('2d');
    plot_period_histogram = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                borderColor: "blue",
                backgroundColor: "blue",
                data: [],
            },],
        },
        options: {
            offset: false,
            animation: true,
            scales: {   
                x: {
                    title:{
                        display: true, 
                        text: gettext('Period [s]'),
                    },
                    grid: {
                        offset: true
                        }
                },
                y: {
                    ticks: {
                        beginAtZero: true
                    },
                    
                }
            },
            plugins: {
                legend: {
                    display: false,
                }, 
                autocolors: false,
            },
        }
    });





    ctx = $("#plot_sample_period")[0].getContext('2d');
    plot_sample_period = new Chart(ctx, {
        type: 'scatterWithErrorBars',
        data: {
            datasets: [{
                borderColor: "blue",
                backgroundColor: "blue",
                data: [ ],
            },],
        },
        options: {
            plugins: {
                legend: {
                    display: false,
                }, 
                autocolors: false,
            },
            scales: {
                y: {
                    title:{
                        display: true, 
                        text: gettext('Period [s]'),
                    },
                },
                x: {
                    title:{
                        display: true, 
                        text: gettext('# Samples'),
                    },
                },
            },
        }
    });

}
function configure_slider(name){
        $('#slider-'+name).slider({
            min:  protocol_input_arguments[name].minimum,
            max: protocol_input_arguments[name].maximum, 
            step: protocol_input_arguments[name].multipleOf,
            start: protocol_input_arguments[name].default,
            input: '#'+name,
            onChange: function(value) {
                console.log("QQQQQQQQQQQQQQQQQQ "+value)
                $('#'+name).prop("value", value)
                onInputChanged()
           }
        })
        $('#'+name).change(function() {
            if($(this).val() > protocol_input_arguments[name].maximum)
                $(this).prop("value", protocol_input_arguments[name].maximum)
            if($(this).val() < protocol_input_arguments[name].minimum)
                $(this).prop("value", protocol_input_arguments[name].minimum)
            $("#slider-"+name).slider('set value', $(this).val())
            });
    }
	
function configure_radio() {
         $('.ui.radio.checkbox').checkbox();
         gas_selector = $('#radio').find('[name="frequency"]:checked').val();
         console.log(gas_selector)
         if (gas_selector === undefined){
                 console.log("error")
                 gas_selector = 1
            }

}


</script>
{% endblock %}   


